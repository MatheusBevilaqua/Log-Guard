<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogGuard - Dashboard</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="css/partials/SideBar.css">
    <script src="js/sessao.js"></script>
    <link rel="shortcut icon" type="imagex/png" href="./img/logo_vetorizada6.png">
</head>

<body onload="validarCargo();validarSessao();visualizarMaquinas()">

    </div>
    <section class="page-dash">
        <nav id="sidebar">
            <div id="sidebar_content">
                <div id="user">
                    <img src="https://apexensino.com.br/wp-content/uploads/2019/02/iStock-1017296544-1024x683.jpg"
                        id="user_avatar" alt="Avatar">

                    <p id="user_infos">
                        <span class="item-description" id="b_usuario">
                        </span>
                        <span class="item-description " id="cargo_usuario" style="color: #442BB3;">
                            Lorem Ipsum
                        </span>
                    </p>

                </div>

                <ul id="side_items">
                    <li class="side_item active">
                        <a style="cursor: auto;">
                            <i><img src="img/logo_vetorizada6.png" class="nav-dash-icon"
                                    style="height: 40px; width: 40px;"></i>
                            <span class="item-description">
                                <b style="color: white;"> LOG GUARD </b>
                            </span>
                        </a>
                    </li>

                    <li class="side_item">
                        <a href="dashboard_ADM.html">
                            <i> <img src="./img/olho.png" class="nav-dash-icon" style="width: 25px;"> </i>
                            <span class="item-description">
                                <b> Visão Geral </b>
                            </span>
                        </a>
                    </li>

                    <li class="side_item">
                        <a href="relatorios.html">
                            <i> <img src="./img/icon-cnpj.png" class="nav-dash-icon"> </i>
                            <span class="item-description">
                                <b> Relatórios </b>
                            </span>
                        </a>
                    </li>

                    <li class="side_item">
                        <a href="gerenciar-maquina.html">
                            <i> <img src="./img/monitor.svg" class="nav-dash-icon"> </i>
                            <span class="item-description">
                                <b> Máquinas </b>
                            </span>
                        </a>
                    </li>

                    <li class="side_item">
                        <a href="gerenciar-usuario-func.html">
                            <i> <img src="./img/icon-man.png" class="nav-dash-icon"> </i>
                            <span class="item-description">
                                <b> Funcionários </b>
                            </span>
                        </a>
                    </li>

                    <li class="side_item">
                        <a href="feedback.html">
                          <i> <img src="./img/e-mail.png" class="nav-dash-icon" style="width: 25px;"> </i>
                          <span class="item-descriptionAtivo">
                            <b> Feedback </b>
                          </span>
                        </a>
                      </li>
                    </ul>


                </ul>

                <button id="open_btn">
                    <i> <img src="./img/seta-direita.png" class="nav-dash-icon"> </i>
                </button>
            </div>

            <div id="logout">
                <button id="logout_btn" onclick="sair()">
                    <i> <img src="img/sair.png" class="nav-dash-icon"> </i>
                    <span class="item-description">
                        Sair
                    </span>
                </button>
            </div>
        </nav>

        <section class="page-dash-geren" onload="validarSessao()">


            <div class="maingerenpage">
                <div class="head-funcionarios-gerenc">
                    <h1>Gerenciar Servidores:</h1>
                    <div class="filtro-no-gerenciar-maquina">
                        <button onclick="filtrarpormaquina()" class="botao-filtro">Filtrar </button>
                        <p>Pesquisar Máquina:</p>
                        <input placeholder="Ex: DT3-11G" type="text">
                    </div>
                </div>
                <div class="dash-geren">
                    <div class="titulos-geren">
                        <div class="coluna-geren">ID</div>
                        <div class="coluna-geren">Nome</div>
                        <div class="coluna-geren">CPU</div>
                        <div class="coluna-geren">Memória</div>
                        <div class="coluna-geren">Disco</div>
                        <div class="coluna-geren">Localidade</div>
                        <div class="coluna-geren">Endereço MAC</div>
                    </div>
                    <div class="linha-geren">
                        <img src="./img/Line1cadastro.png" alt="">
                    </div>
                    <div class="geren-dados" id="geren-dados">

                    </div>
                </div>
                <div class="botoes-geren">
                    <!-- <button onclick="editar_maquina()" class="edit-geren">Editar</button> -->
                    <button onclick="cadastrar_maquina()" class="cad-geren">Cadastrar Servidor</button>
                </div>
            </div>

            <div class="Editargeren">
                <div class="Editar-geren-segundo">

                    <div class="Editar-geren-botoes">
                        <button onclick="cancelar_editar()" class="cancelar-geren">X</button>
                    </div>
                </div>
                <div class="Editar-geren-primeiro">
                    <h1>Alterar as configurações do servidor:</h1>
                    <div class="configuracoes-servidores">
                        <div class="divisorias-titulos-maquinas-1">
                            <div class="titulos-maquina-atribuicao">
                                <p>Nome do servidor</p>
                            </div>
                            <input placeholder="Ex: HLE-STEP2" type="text" id="input_alterar_nome">

                            <div class="titulos-maquina-atribuicao">
                                <p>Modelo da CPU</p>
                            </div>
                            <input placeholder="Ex: Ryzen 5 1600AF" type="text" id="input_alterar_modeloCPU">

                            <div class="titulos-maquina-atribuicao">
                                <p>RAM(Gb)</p>
                            </div>
                            <input placeholder="Ex: 500" type="text" id="input_alterar_capacidadeRAM">

                        </div>
                        <div class="divisorias-titulos-maquinas-2">
                            <div class="titulos-maquina-atribuicao">
                                <p>Disco(TB)</p>
                            </div>
                            <input placeholder="Ex: 20" type="text" id="input_alterar_disco">

                            <div class="titulos-maquina-atribuicao">
                                <p>Localidade</p>
                            </div>
                            <input placeholder="Ex: Datacenter 5" type="text" id="input_alterar_localidade">

                        </div>
                    </div>
                </div>

                <img src="./img/Line1cadastro.png" class="line1-geren" alt="">
                <div class="editar-geren-titulodelet">
                    <h1>Gerenciar Servidor:</h1>
                </div>
                <div class="Editar-geren-botao-delete">
                    <button onclick="confirmar_editar()" class="confirmar-geren">Confirmar Configurações</button>
                    <button onclick="excluir_editar()" class="excluir-geren">Excluir Servidor</button>
                </div>
            </div>

            <div class="Cadastrargeren">
                <h1>Cadastrar novo servidor:</h1>
                <div class="cadastrar-geren-primeiro">
                    <div class="divisorias-maquinas-1">
                        <p>Nome do servidor</p>
                        <input placeholder="Ex: HLE-STEP2" type="text" id="nome_input">
                        <p>Modelo da CPU</p>
                        <input placeholder="Ex: Ryzen 5 1600AF" type="text" id="modeloCPU_input">
                        <p>RAM(GB)</p>
                        <input placeholder="Ex: 500" type="text" id="capacidadeRAM_input">
                    </div>
                    <div class="divisorias-maquinas-2">
                        <p>Disco(TB)</p>
                        <input placeholder="Ex: 20" type="text" id="disco_input">
                        <p>Localidade</p>
                        <input placeholder="Ex: Datacenter 5" type="text" id="localidade_input">
                        <p>Endereço MAC</p>
                        <input placeholder="Ex: 00:19:B9:FB:E2:58" type="text" id="MACAdress_input" oninput="mascaraMAC(this)">
                    </div>

                </div>
                <div class="cadastrar-geren-terceiro">
                    <button onclick="confirmar_cadastrar()" class="confirmar-geren">Confirmar Configurações</button>
                    <button onclick="cancelar_cadastrar()" class="cancelar-geren">X</button>
                </div>
            </div>
            </div>
            <dialog class="dialogodefiltromaquina">
                <div class="dialogodefiltromaquinatitulo">
                    <h2>Filtrar por</h2>
                    <div class="Editarbotaofechar">
                        <button onclick="cancelar_filtro()" class="cancelarfiltro">X</button>
                    </div>
                </div>
                <div class="regiaocentrofiltros">
                    <div class="regiaocentrofiltros-particao1">

                        <div class="particao1-inputselect">
                            <p>Localidade</p>
                            <select name="select1">
                                <option value="valor0" disabled selected>Selecione a localidade</option>
                                <option value="valor1">Datacenter 1</option>
                                <option value="valor2">Datacenter 2</option>
                            </select>
                        </div>

                        <div class="particao1-inputselect">
                            <p>Tipo de CPU</p>
                            <select name="select2">
                                <option value="valor0" disabled selected>Selecione o tipo</option>
                                <option value="valor1">T2 MEDIUM</option>
                                <option value="valor2">T2 LARGE</option>
                            </select>
                        </div>

                        <div class="particao1-inputselect">
                            <p>Máquinas atribuidas ao funcionário</p>
                            <select name="select2">
                                <option value="valor0" disabled selected>Selecione o usuário</option>
                                <option value="valor1">Jhonatan</option>
                                <option value="valor2">Fabrício</option>
                            </select>
                        </div>

                    </div>
                    <div class="regiaocentrofiltros-particao2">
                        <div class="particao1-inputselect">
                            <p>Selecione a opção de filtro</p> <select id="select2" onchange="selectFiltro()">
                                <option id="valor0" value="valor0" disabled selected>Selecione o filtro</option>
                                <option id="valor1" value="valor1">ID Máquina</option>
                                <option id="valor2" value="valor2">Nome da máquina</option>
                                <option id="valor3" value="valor3">Quantidade de alertas</option>
                            </select>
                        </div>
                        <div class="particao-maquinafiltro-1" style="display: none;">
                            <div class="particao2-inputitulo">
                                <p>ID Máquina</p>
                            </div>
                            <div class="particao2-grupocheckbox">
                                <div class="particao2-inputcheckbox"> <input id="check1" type="checkbox">
                                    <p id="check1-label">Crescente</p>
                                </div>
                                <div class="particao2-inputcheckbox"> <input id="check2" type="checkbox">
                                    <p id="check2-label">Decrescente</p>
                                </div>
                            </div>
                        </div>
                        <div class="particao-maquinafiltro-2" style="display: none;">
                            <div class="particao2-inputitulo">
                                <p>Nome da máquina</p>
                            </div>
                            <div class="particao2-grupocheckbox">
                                <div class="particao2-inputcheckbox"> <input id="check3" type="checkbox">
                                    <p id="check3-label">de A até Z</p>
                                </div>
                                <div class="particao2-inputcheckbox"> <input id="check4" type="checkbox">
                                    <p id="check4-label">de Z até A</p>
                                </div>
                            </div>
                        </div>
                        <div class="particao-maquinafiltro-3" style="display: none;">
                            <div class="particao2-inputitulo">
                                <p>Quantidade de alertas</p>
                            </div>
                            <div class="particao2-grupocheckbox">
                                <div class="particao2-inputcheckbox"> <input id="check5" type="checkbox">
                                    <p id="check5-label">Crescente</p>
                                </div>
                                <div class="particao2-inputcheckbox"> <input id="check6" type="checkbox">
                                    <p id="check6-label">Decrescente</p>
                                </div>
                            </div>
                        </div>

                        <div class="filtro-botao-confirmar">
                            <button onclick="confirmar_filtrar()" class="confirmarfiltro">Filtrar</button>
                        </div>

                    </div>

                </div>


            </dialog>
        </section>



</body>

</html>

<script>

function selectFiltro() {
    var select = document.getElementById('select2');
    var valor = select.value;


    document.querySelector('.particao-maquinafiltro-1').style.display = "none";
    document.querySelector('.particao-maquinafiltro-2').style.display = "none";
    document.querySelector('.particao-maquinafiltro-3').style.display = "none";

    if (valor === "valor1") {
        document.querySelector('.particao-maquinafiltro-1').style.display = "block";
    } else if (valor === "valor2") {
        document.querySelector('.particao-maquinafiltro-2').style.display = "block";
    } else if (valor === "valor3") {
        document.querySelector('.particao-maquinafiltro-3').style.display = "block";
    }
}


    function filtrarpormaquina() {
        document.querySelector('.maingerenpage').style.filter = "blur(5px)";
        document.querySelector('.dialogodefiltromaquina').style.display = "block";
    }

    document.getElementById('open_btn').addEventListener('click', function () {
        document.getElementById('sidebar').classList.toggle('open-sidebar');
    });

    function sair() {
        window.location.href = "index.html";
    }
    var idEmpresaUsuario = sessionStorage.EMPRESA_USUARIO
    var idMaquina = ""

    function confirmar_editar() {
        // temporario
        document.querySelector('.maingerenpage').style.filter = "blur(0px)";
        document.querySelector('.Editargeren').style.display = "none";
        {
            var r = confirm("Tem certeza que deseja alterar este perfil?");
            if (r == true) {
                editarMaquina();
            } else {
                alert("Algo deu errado na alteração de perfil!");
            }
        }
    }



    function cancelar_editar() {
        document.querySelector('.maingerenpage').style.filter = "blur(0px)";
        document.querySelector('.Editargeren').style.display = "none";
    }

    function cancelar_filtro() {
        document.querySelector('.maingerenpage').style.filter = "blur(0px)";
        document.querySelector('.dialogodefiltromaquina').style.display = "none";
    }

    function excluir_editar() {
        var r = confirm("Tem certeza que deseja excluir este servidor?");
        if (r == true) {
            deletarMaquina()
            window.location.reload(true); //reload na página
        }
    }

    function confirmar_cadastrar() {


        var nomeMaquinaVAR = nome_input.value;
        var modeloCPUVAR = modeloCPU_input.value;
        var capacidadeRAMVAR = capacidadeRAM_input.value;
        var discoVAR = disco_input.value;
        var localidadeVAR = localidade_input.value;
        var MACAdressVAR = MACAdress_input.value;



        if (
            nomeMaquinaVAR == "" ||
            modeloCPUVAR == "" ||
            capacidadeRAMVAR == "" ||
            discoVAR == "" ||
            localidadeVAR == "" ||
            MACAdressVAR == ""
        ) {
            alert("Todos os campos dever ser preenchidos!")
            return false;
        } else {

            fetch("/empresas/confirmar_cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({

                    nomeMaquinaServer: nomeMaquinaVAR,
                    modeloCServer: modeloCPUVAR,
                    capacidadeServer: capacidadeRAMVAR,
                    discoServer: discoVAR,
                    localidadeServer: localidadeVAR,
                    MACAdressServer: MACAdressVAR,
                    fkEmpresaMaquinaServer: sessionStorage.EMPRESA_USUARIO
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {

                        alert("CADASTRO EXECUTADO!")
                        window.location.reload(true); //reload na página
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastro!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);

                });

            return false;
        }
        // temporario
        document.querySelector('.maingerenpage').style.filter = "blur(0px)";
        document.querySelector('.Cadastrargeren').style.display = "none";
    }

    function cancelar_cadastrar() {
        document.querySelector('.maingerenpage').style.filter = "blur(0px)";
        document.querySelector('.Cadastrargeren').style.display = "none";
    }


    function cadastrar_maquina() {
        document.querySelector('.maingerenpage').style.filter = "blur(5px)";
        document.querySelector('.Cadastrargeren').style.display = "block";

    }
    // function publicar_relatorio() {
    //     document.querySelector('.maingerenpage').style.filter = "blur(5px)";
    //     document.querySelector('.Cadastrargeren').style.display = "block";

    // }
    function visualizarMaquinas() {

        var instrucao = ""

        instrucao = "SELECT * FROM maquina WHERE fkEmpresaMaquina = " + idEmpresaUsuario + ";"

        fetch("/empresas/visualizarMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({instrucaoServer: instrucao}),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var lista = document.getElementById("dash-func");
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = "Nenhuma máquina encontrada."
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var lista = document.getElementById("geren-dados");


                        for (let i = 0; i < resposta.length; i++) {

                            let tupla = resposta[i];
                            var divLista = document.createElement("div");
                            var divId = document.createElement("div");
                            var divnome = document.createElement("div");
                            var divCPU = document.createElement("div");
                            var divRAM = document.createElement("div");
                            var divDisco = document.createElement("div");
                            var divLocalidade = document.createElement("div");
                            var divMAC = document.createElement("div");

                            divLista.className = "dados-geren";
                            divId.className = "coluna-geren";
                            divnome.className = "coluna-geren";
                            divCPU.className = "coluna-geren";
                            divRAM.className = "coluna-geren";
                            divDisco.className = "coluna-geren";
                            divLocalidade.className = "coluna-geren";
                            divMAC.className = "coluna-geren";

                            divId.innerHTML = tupla.idMaquina;
                            divnome.innerHTML = tupla.nomeMaquina;
                            divCPU.innerHTML = tupla.modeloCPU;
                            divRAM.innerHTML = tupla.capacidadeRAM;
                            divDisco.innerHTML = tupla.disco;
                            divLocalidade.innerHTML = tupla.localidade;
                            divMAC.innerHTML = tupla.MACAdress;


                            divLista.appendChild(divId);
                            divLista.appendChild(divnome);
                            divLista.appendChild(divCPU);
                            divLista.appendChild(divRAM);
                            divLista.appendChild(divDisco);
                            divLista.appendChild(divLocalidade);
                            divLista.appendChild(divMAC);

                            let debounceTimeout;
                            divLista.addEventListener("click", function () {
                                if (debounceTimeout) {
                                    clearTimeout(debounceTimeout);
                                }

                                debounceTimeout = setTimeout(function () {
                                    gerenciarMaquina(tupla.idMaquina);
                                }, 200);
                            });


                            lista.appendChild(divLista);
                        }

                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
    }

    function gerenciarMaquina(idMaquinaSelecionada) {

        idMaquina = idMaquinaSelecionada

        fetch("/empresas/exibirDadosEdicaoMaquina", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idMaquinaServer: idMaquinaSelecionada,
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (json) {

                        let nomeMaquinaEdicao = json.nomeMaquina;
                        let modeloCPUMaquinaEdicao = json.modeloCPU;
                        let capacidadeRAMaquinaEdicao = json.capacidadeRAM;
                        let discoMaquinaEdicao = json.disco;
                        let localidadeMaquinaEdicao = json.localidade;


                        document.getElementById("input_alterar_nome").value = nomeMaquinaEdicao;
                        document.getElementById("input_alterar_modeloCPU").value = modeloCPUMaquinaEdicao;
                        document.getElementById("input_alterar_capacidadeRAM").value = capacidadeRAMaquinaEdicao;
                        document.getElementById("input_alterar_disco").value = discoMaquinaEdicao;
                        document.getElementById("input_alterar_localidade").value = localidadeMaquinaEdicao;

                        document.querySelector('.maingerenpage').style.filter = "blur(5px)";
                        document.querySelector('.Editargeren').style.display = "block";


                    });
                } else {
                    console.error("Houve um erro na requisição");
                }
            })
            .catch(function (erro) {
                console.error("Erro ao tentar buscar os dados do usuário:", erro);
            });

        return false;
    }

    function deletarMaquina() {
        alert("Máquina deletada com sucesso!");

        fetch("/empresas/deletarMaquina", {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idMaquinaServer: idMaquina,
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (json) {
                        console.log("Máquina deletada com sucesso:", json);
                        verUsuarios();
                    });
                } else {
                    console.error("Houve um erro na requisição");
                }
            })
            .catch(function (erro) {
                console.error("Erro ao tentar deletar a máquina:", erro);
            });

        return false;
    }
    function editarMaquina() {

        var nomeMaquinaVAR = input_alterar_nome.value;
        var modeloCPUVAR = input_alterar_modeloCPU.value;
        var capacidadeRAMVAR = input_alterar_capacidadeRAM.value;
        var discoVAR = input_alterar_disco.value;
        var localidadeVAR = input_alterar_localidade.value;

        if (
            nomeMaquinaVAR == "" ||
            modeloCPUVAR == "" ||
            capacidadeRAMVAR == "" ||
            discoVAR == "" ||
            localidadeVAR == ""
        ) {
            alert("Todos os campos dever ser preenchidos!")
            return false;
        } else {


            console.log("Dados a serem enviados:", {
                nomeMaquinaServer: nomeMaquinaVAR,
                modeloCPUServer: modeloCPUVAR,
                capacidadeRAMServer: capacidadeRAMVAR,
                discoServer: discoVAR,
                localidadeServer: localidadeVAR,
            });
            fetch("/empresas/editarMaquina", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idMaquinaServer: idMaquina,
                    nomeMaquinaServer: nomeMaquinaVAR,
                    modeloCPUServer: modeloCPUVAR,
                    capacidadeRAMServer: capacidadeRAMVAR,
                    discoServer: discoVAR,
                    localidadeServer: localidadeVAR,
                }),
            })
                .then(function (resposta) {
                    console.log("Status da resposta:", resposta.status);
                    if (resposta.ok) {

                        resposta.json().then(function (json) {
                            console.log("Máquina atualizada com sucesso:", json);
                            alert("Perfil alterado com sucesso!");
                            window.location.reload(true);
                        });
                    } else {
                        resposta.text().then(function (texto) {
                            console.error("Erro na resposta:", texto);
                        });
                    }
                })
                .catch(function (erro) {
                    console.error("Erro ao tentar alterar os dados da máquina:", erro);
                });
        }
    }

    function mascaraMAC(element) {
        // Remove caracteres que não sejam dígitos ou letras
        let value = element.value.replace(/[^A-Fa-f0-9]/g, '');
        
        // Aplica a máscara ao valor
        let formatted = '';
        for (let i = 0; i < value.length && i < 12; i += 2) {
            formatted += value.substring(i, i + 2) + (i < 10 ? ':' : '');
        }
        
        // Atualiza o valor no campo de entrada
        element.value = formatted;
    }

</script>